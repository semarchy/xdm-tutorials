/*
 * Step 2: Load Data
 * Insert the Customers' Products Data Statements with delta detection.
 * Load the SA table because PersonProduct is a basic entity.
 * Run as SEMARCHY_CUSTOMER_B2C_MDM user.
 */
INSERT into SEMARCHY_CUSTOMER_B2C_MDM.SA_PERSON_PRODUCT (
     B_LOADID      /* Semarchy system fields */
    ,B_CLASSNAME   /* Semarchy system fields */
    ,ID
    ,PURCHASE_DATE
    ,REGISTRATION_DATE
    ,F_PRODUCT
    ,FP_PERSON
    ,FS_PERSON
)
SELECT
     /* load_id */ as B_LOADID    /* Insert the load ID here that was returned from Step 4 */
    ,'PersonProduct' AS B_CLASSNAME /* Entity name. Found in MDM Workbench UI. */
    ,stg.ID
    ,stg.PURCHASE_DATE
    ,stg.REGISTRATION_DATE
    ,stg.F_PRODUCT
    ,stg.FP_PERSON
    ,stg.FS_PERSON
FROM SEMARCHY_CUSTOMER_B2C_MDM.SA_PERSON_PRODUCT dest
RIGHT JOIN (
    VALUES 
		('FORCEP24461WD_CRM1353638', TO_DATE('06/23/2018', 'MM-DD-YYYY'), TO_DATE('07/13/2018', 'MM-DD-YYYY'), 'FORCEP24461WD', 'CRM', '1353638'),
		('FORCEP24461WD_CRM1388894', TO_DATE('02/10/2016', 'MM-DD-YYYY'), TO_DATE('04/02/2016', 'MM-DD-YYYY'), 'FORCEP24461WD', 'CRM', '1388894'),
		('CARBON4861OK_CRM1987232', TO_DATE('12/19/2016', 'MM-DD-YYYY'), TO_DATE('03/20/2017', 'MM-DD-YYYY'), 'CARBON4861OK', 'CRM', '1987232'),
		('CARBON4861OK_CRM1373036', TO_DATE('04/28/2014', 'MM-DD-YYYY'), TO_DATE('06/22/2014', 'MM-DD-YYYY'), 'CARBON4861OK', 'CRM', '1373036'),
		('CARBON4861OK_CRM1380327', TO_DATE('01/17/2016', 'MM-DD-YYYY'), TO_DATE('04/26/2016', 'MM-DD-YYYY'), 'CARBON4861OK', 'CRM', '1380327'),
		('CARBON4861OK_CRM1385755', TO_DATE('04/23/2015', 'MM-DD-YYYY'), TO_DATE('06/12/2015', 'MM-DD-YYYY'), 'CARBON4861OK', 'CRM', '1385755'),
		('CARBON4861OK_CRM1391755', TO_DATE('05/23/2016', 'MM-DD-YYYY'), TO_DATE('08/02/2016', 'MM-DD-YYYY'), 'CARBON4861OK', 'CRM', '1391755'),
		('CARBON4861OK_MKT1387232', TO_DATE('02/16/2016', 'MM-DD-YYYY'), TO_DATE('05/21/2016', 'MM-DD-YYYY'), 'CARBON4861OK', 'MKT', '1387232'),
		('CARBON4861OK_MKT1388559', TO_DATE('08/30/2015', 'MM-DD-YYYY'), TO_DATE('11/22/2015', 'MM-DD-YYYY'), 'CARBON4861OK', 'MKT', '1388559'),
		('RENAUD4061LK_CRM1376827', TO_DATE('06/02/2018', 'MM-DD-YYYY'), TO_DATE('07/13/2018', 'MM-DD-YYYY'), 'RENAUD4061LK', 'CRM', '1376827'),
		('STREAM4961WD_CRM1353638', TO_DATE('09/19/2014', 'MM-DD-YYYY'), TO_DATE('12/21/2014', 'MM-DD-YYYY'), 'STREAM4961WD', 'CRM', '1353638')
) AS stg(ID, PURCHASE_DATE, REGISTRATION_DATE, F_PRODUCT, FP_PERSON, FS_PERSON)
ON dest.ID = stg.ID
WHERE dest.ID IS NULL OR (
    dest.PURCHASE_DATE <> stg.PURCHASE_DATE
    OR dest.REGISTRATION_DATE <> stg.REGISTRATION_DATE
    OR COALESCE(dest.F_PRODUCT, '') <> COALESCE(stg.F_PRODUCT, '')
    OR COALESCE(dest.FP_PERSON, '') <> COALESCE(stg.FP_PERSON, '')
    OR COALESCE(dest.FS_PERSON, '') <> COALESCE(stg.FS_PERSON, '')
);
COMMIT;
